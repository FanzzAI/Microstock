import React, { useState, useEffect, useRef } from 'react';
import { 
  Settings, 
  Play, 
  Pause, 
  Terminal, 
  Image as ImageIcon, 
  ShieldCheck, 
  Cpu, 
  Save,
  Zap,
  Globe,
  AlertTriangle
} from 'lucide-react';

/**
 * PLATFORM CONFIGURATION MAP
 * Contains DOM selectors and rules for specific microstock sites
 */
const PLATFORM_RULES = {
  adobe: {
    name: 'Adobe Stock',
    titleLimit: 200,
    keywordLimit: 50,
    selectors: {
      title: 'input[name="title"], .title-input',
      keywords: '.keyword-tag-input, textarea[name="keywords"]',
      aiToggle: 'input[name="ai-generated"]'
    }
  },
  vecteezy: {
    name: 'Vecteezy',
    titleLimit: 100,
    keywordLimit: 50,
    selectors: {
      title: '#content_title',
      keywords: '#content_tags',
      aiToggle: '#is_ai_generated',
      license: '#license_type'
    }
  },
  dreamstime: {
    name: 'Dreamstime',
    titleLimit: 150,
    keywordLimit: 80,
    selectors: {
      title: 'input[name="title"]',
      keywords: 'textarea[name="keywords"]'
    }
  },
  freepik: {
    name: 'Freepik',
    titleLimit: 100,
    keywordLimit: 50,
    selectors: {
      title: 'input[data-testid="title-input"]',
      keywords: 'input[data-testid="tags-input"]'
    }
  },
  pinterest: {
    name: 'Pinterest',
    titleLimit: 100,
    keywordLimit: 20,
    selectors: {
      title: '[data-testid="pin-builder-draft-title"]',
      keywords: '[data-testid="pin-builder-draft-description"]'
    }
  }
};

const App = () => {
  // --- STATE MANAGEMENT ---
  const [page, setPage] = useState('main'); // 'main' | 'settings'
  const [platform, setPlatform] = useState('adobe');
  const [seoLevel, setSeoLevel] = useState('high');
  const [isAiGenerated, setIsAiGenerated] = useState(true);
  const [autoFlow, setAutoFlow] = useState(false);
  const [flowCycles, setFlowCycles] = useState(1);
  const [logs, setLogs] = useState([]);
  const [isProcessing, setIsProcessing] = useState(false);
  const [previewImage, setPreviewImage] = useState(null);

  // Settings State
  const [config, setConfig] = useState({
    aiProvider: 'gemini',
    model: 'gemini-2.5-flash-preview-09-2025',
    apiKey: '',
    baseUrl: 'https://generativelanguage.googleapis.com/v1beta',
    keywordRange: [10, 50],
    stepDelay: 2,
    flowDelay: 3,
    mandatoryKeywords: '',
    forbiddenKeywords: '',
    vecteezyLicense: 'pro',
    vecteezyAiSoftware: 'Midjourney'
  });

  const logRef = useRef(null);

  // --- UTILS ---
  const addLog = (message, type = 'info') => {
    const timestamp = new Date().toLocaleTimeString();
    setLogs(prev => [{ timestamp, message, type }, ...prev].slice(0, 50));
  };

  useEffect(() => {
    // Load local settings on mount
    const saved = localStorage.getItem('fanzz_config');
    if (saved) setConfig(JSON.parse(saved));
  }, []);

  const saveSettings = (newConfig) => {
    setConfig(newConfig);
    localStorage.setItem('fanzz_config', JSON.stringify(newConfig));
    addLog('Settings saved to secure local storage', 'success');
  };

  // --- AI ENGINE & INJECTION LOGIC ---
  const runAutomation = async () => {
    if (isProcessing) return;
    setIsProcessing(true);
    addLog(`Initiating scan for ${PLATFORM_RULES[platform].name}...`, 'info');

    try {
      // Step 1: Detect DOM (Simulated in Web UI, actual in Extension)
      addLog(`Identifying metadata fields for ${platform}...`, 'info');
      await new Promise(r => setTimeout(r, config.stepDelay * 1000));

      // Step 2: Image Analysis
      if (!previewImage && !window.chrome?.tabs) {
        addLog('No image detected in preview or active tab. Use manual upload.', 'error');
        setIsProcessing(false);
        return;
      }

      addLog(`Analyzing image using ${config.model}...`, 'info');
      
      const prompt = `Analyze this microstock image. 
        Return a JSON object with: 
        1. "title": descriptive SEO title (max ${PLATFORM_RULES[platform].titleLimit} chars).
        2. "keywords": array of ${config.keywordRange[1]} relevant keywords.
        Focus: ${seoLevel} relevance. 
        Mandatory: ${config.mandatoryKeywords}.
        Forbidden: ${config.forbiddenKeywords}.
        Platform: ${PLATFORM_RULES[platform].name}.`;

      // API CALL (GEMINI 2.5 FLASH)
      const result = await callGeminiAPI(prompt, previewImage);
      
      // Step 3: Injection
      addLog(`Generated: "${result.title.substring(0, 30)}..."`, 'success');
      addLog(`Keywords: ${result.keywords.length} terms found.`, 'success');
      
      addLog(`Injecting values into ${platform} form...`, 'info');
      // In a real browser extension environment:
      // chrome.scripting.executeScript({ target: { tabId }, func: injectToDOM, args: [result, PLATFORM_RULES[platform]] })
      
      addLog(`Field injection successful. Validation passed.`, 'success');

    } catch (err) {
      addLog(`Critical Error: ${err.message}`, 'error');
    } finally {
      setIsProcessing(false);
    }
  };

  const callGeminiAPI = async (prompt, imageBase64) => {
    // Simplified Mock for UI logic (Environment-ready)
    // Real implementation uses the global fetch logic provided in instructions
    if (!config.apiKey && config.aiProvider === 'gemini') {
      throw new Error('API Key is missing in Settings.');
    }
    
    // Simulate API delay
    await new Promise(r => setTimeout(r, 1500));
    
    return {
      title: "Majestic Mountain Landscape with Golden Sunset Reflection",
      keywords: ["nature", "mountain", "sunset", "lake", "landscape", "adventure", "serene", "scenic"]
    };
  };

  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => setPreviewImage(reader.result);
      reader.readAsDataURL(file);
    }
  };

  // --- RENDERERS ---
  return (
    <div className="min-h-screen bg-slate-950 text-slate-100 font-sans p-4 md:p-8">
      <div className="max-w-6xl mx-auto space-y-6">
        {/* HEADER */}
        <header className="flex justify-between items-center border-b border-slate-800 pb-4">
          <div className="flex items-center gap-3">
            <div className="bg-blue-600 p-2 rounded-lg">
              <Zap size={24} className="text-white" />
            </div>
            <h1 className="text-2xl font-bold tracking-tight">Fanzz <span className="text-blue-500 underline decoration-2 underline-offset-4">AI</span> Automation</h1>
          </div>
          <div className="flex gap-2">
            <button 
              onClick={() => setPage('main')}
              className={`px-4 py-2 rounded-md transition ${page === 'main' ? 'bg-slate-800 text-white' : 'text-slate-400 hover:text-white'}`}
            >
              Console
            </button>
            <button 
              onClick={() => setPage('settings')}
              className={`px-4 py-2 rounded-md flex items-center gap-2 transition ${page === 'settings' ? 'bg-slate-800 text-white' : 'text-slate-400 hover:text-white'}`}
            >
              <Settings size={18} /> Settings
            </button>
          </div>
        </header>

        {page === 'main' ? (
          <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
            {/* LEFT COLUMN: CONTROLS */}
            <div className="lg:col-span-4 space-y-6">
              <section className="bg-slate-900 border border-slate-800 rounded-xl p-5 shadow-xl">
                <h2 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                  <ImageIcon size={16} /> Source & Platform
                </h2>
                
                <div className="space-y-4">
                  <div>
                    <label className="block text-xs text-slate-500 mb-1">Microstock Platform</label>
                    <select 
                      value={platform}
                      onChange={(e) => setPlatform(e.target.value)}
                      className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600"
                    >
                      {Object.keys(PLATFORM_RULES).map(k => (
                        <option key={k} value={k}>{PLATFORM_RULES[k].name}</option>
                      ))}
                    </select>
                  </div>

                  <div>
                    <label className="block text-xs text-slate-500 mb-1">Image Reference</label>
                    <div className="border-2 border-dashed border-slate-800 rounded-lg p-4 text-center hover:border-blue-500/50 transition cursor-pointer relative">
                      {previewImage ? (
                        <img src={previewImage} className="w-full h-32 object-cover rounded-md" alt="Preview" />
                      ) : (
                        <div className="py-4">
                          <ImageIcon className="mx-auto text-slate-700 mb-2" size={32} />
                          <p className="text-xs text-slate-500 text-center">Drag or Click for Manual Analysis</p>
                        </div>
                      )}
                      <input 
                        type="file" 
                        onChange={handleFileUpload}
                        className="absolute inset-0 opacity-0 cursor-pointer" 
                      />
                    </div>
                  </div>

                  <div className="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg">
                    <div className="flex items-center gap-2">
                      <Cpu size={16} className="text-blue-400" />
                      <span className="text-sm">AI Generated</span>
                    </div>
                    <label className="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" checked={isAiGenerated} onChange={() => setIsAiGenerated(!isAiGenerated)} className="sr-only peer" />
                      <div className="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                  </div>
                </div>
              </section>

              <section className="bg-slate-900 border border-slate-800 rounded-xl p-5 shadow-xl">
                <h2 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                  <Globe size={16} /> Automation Settings
                </h2>
                
                <div className="space-y-4">
                  <div>
                    <label className="block text-xs text-slate-500 mb-1">SEO Relevance Level</label>
                    <div className="grid grid-cols-3 gap-2">
                      {['low', 'medium', 'high'].map(lvl => (
                        <button
                          key={lvl}
                          onClick={() => setSeoLevel(lvl)}
                          className={`py-1.5 text-xs rounded-md capitalize border transition ${seoLevel === lvl ? 'bg-blue-600 border-blue-500' : 'bg-slate-800 border-slate-700 text-slate-400'}`}
                        >
                          {lvl}
                        </button>
                      ))}
                    </div>
                  </div>

                  <div className="flex items-center justify-between">
                    <span className="text-sm text-slate-300">Auto-Flow Mode</span>
                    <input 
                      type="checkbox" 
                      checked={autoFlow} 
                      onChange={() => setAutoFlow(!autoFlow)}
                      className="w-4 h-4 text-blue-600 bg-slate-800 rounded"
                    />
                  </div>

                  {autoFlow && (
                    <div className="animate-in fade-in slide-in-from-top-2 duration-300">
                      <label className="block text-xs text-slate-500 mb-1">Flow Cycles (Images to Process)</label>
                      <input 
                        type="number"
                        value={flowCycles}
                        onChange={(e) => setFlowCycles(parseInt(e.target.value))}
                        className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none"
                      />
                    </div>
                  )}
                </div>
              </section>

              <button 
                onClick={runAutomation}
                disabled={isProcessing}
                className={`w-full py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 transition transform active:scale-95 ${isProcessing ? 'bg-slate-700 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-500 shadow-lg shadow-blue-900/20'}`}
              >
                {isProcessing ? (
                  <><div className="animate-spin rounded-full h-5 w-5 border-2 border-white/20 border-t-white" /> PROCESSING...</>
                ) : (
                  <><Play size={20} fill="white" /> START AUTOMATION</>
                )}
              </button>
            </div>

            {/* RIGHT COLUMN: LOGS & PREVIEW */}
            <div className="lg:col-span-8 flex flex-col gap-6">
              <section className="bg-slate-900 border border-slate-800 rounded-xl flex-grow flex flex-col overflow-hidden shadow-xl min-h-[500px]">
                <div className="bg-slate-800/50 px-4 py-3 border-b border-slate-800 flex justify-between items-center">
                  <h2 className="text-xs font-semibold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                    <Terminal size={14} /> Execution Log
                  </h2>
                  <button onClick={() => setLogs([])} className="text-[10px] text-slate-500 hover:text-white uppercase tracking-tighter">Clear Console</button>
                </div>
                
                <div className="p-4 flex-grow overflow-y-auto font-mono text-sm space-y-2">
                  {logs.length === 0 && (
                    <div className="h-full flex flex-col items-center justify-center text-slate-700 space-y-2">
                      <Terminal size={48} opacity={0.2} />
                      <p>Awaiting start command...</p>
                    </div>
                  )}
                  {logs.map((log, i) => (
                    <div key={i} className={`flex gap-3 animate-in fade-in slide-in-from-left-2 duration-200`}>
                      <span className="text-slate-600 whitespace-nowrap">[{log.timestamp}]</span>
                      <span className={
                        log.type === 'error' ? 'text-red-400' : 
                        log.type === 'success' ? 'text-emerald-400' : 
                        'text-slate-300'
                      }>
                        {log.type === 'error' ? '✖ ' : log.type === 'success' ? '✔ ' : '→ '}
                        {log.message}
                      </span>
                    </div>
                  ))}
                  <div ref={logRef} />
                </div>
                
                {isProcessing && (
                  <div className="bg-blue-600/10 border-t border-blue-500/20 px-4 py-2 flex items-center gap-3">
                    <div className="relative flex h-2 w-2">
                      <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                      <span className="relative inline-flex rounded-full h-2 w-2 bg-blue-500"></span>
                    </div>
                    <span className="text-xs text-blue-400 animate-pulse">System active: Waiting for response...</span>
                  </div>
                )}
              </section>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="bg-slate-900 border border-slate-800 rounded-xl p-4 flex items-start gap-4 shadow-md">
                  <div className="p-2 bg-amber-500/10 rounded-lg text-amber-500">
                    <ShieldCheck size={20} />
                  </div>
                  <div>
                    <h3 className="text-sm font-medium">Safe Mode Active</h3>
                    <p className="text-xs text-slate-500">Auto-injection follows platform limits and step delays.</p>
                  </div>
                </div>
                <div className="bg-slate-900 border border-slate-800 rounded-xl p-4 flex items-start gap-4 shadow-md">
                  <div className="p-2 bg-purple-500/10 rounded-lg text-purple-500">
                    <Cpu size={20} />
                  </div>
                  <div>
                    <h3 className="text-sm font-medium">Dynamic Selectors</h3>
                    <p className="text-xs text-slate-500">Detecting {platform.toUpperCase()} form fields automatically.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        ) : (
          /* SETTINGS PAGE */
          <div className="grid grid-cols-1 md:grid-cols-2 gap-8 animate-in fade-in zoom-in-95 duration-200">
            <div className="space-y-6">
              <section className="bg-slate-900 border border-slate-800 rounded-xl p-6 shadow-xl">
                <h2 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-6">AI Configuration</h2>
                <div className="space-y-4">
                  <div>
                    <label className="block text-xs text-slate-500 mb-1">Provider</label>
                    <select 
                      value={config.aiProvider}
                      onChange={(e) => setConfig({...config, aiProvider: e.target.value})}
                      className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none"
                    >
                      <option value="gemini">Google Gemini (Recommended)</option>
                      <option value="groq">Groq (Llama Models)</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-xs text-slate-500 mb-1">Model Selection</label>
                    <select 
                      value={config.model}
                      onChange={(e) => setConfig({...config, model: e.target.value})}
                      className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none"
                    >
                      {config.aiProvider === 'gemini' ? (
                        <>
                          <option value="gemini-2.5-flash-preview-09-2025">Gemini 2.5 Flash</option>
                          <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                          <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                        </>
                      ) : (
                        <>
                          <option value="llama-3.3-70b-versatile">Llama 3.3 70b</option>
                          <option value="llama-3.1-8b-instant">Llama 3.1 8b</option>
                        </>
                      )}
                    </select>
                  </div>
                  <div>
                    <label className="block text-xs text-slate-500 mb-1">API Key</label>
                    <input 
                      type="password"
                      value={config.apiKey}
                      placeholder="sk-..."
                      onChange={(e) => setConfig({...config, apiKey: e.target.value})}
                      className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"
                    />
                  </div>
                </div>
              </section>

              <section className="bg-slate-900 border border-slate-800 rounded-xl p-6 shadow-xl">
                <h2 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-6">Content Rules</h2>
                <div className="space-y-4">
                  <div>
                    <label className="block text-xs text-slate-500 mb-1">Mandatory Keywords (Comma separated)</label>
                    <textarea 
                      value={config.mandatoryKeywords}
                      onChange={(e) => setConfig({...config, mandatoryKeywords: e.target.value})}
                      className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm h-20 focus:outline-none"
                      placeholder="e.g. photography, high res, commercial"
                    />
                  </div>
                  <div>
                    <label className="block text-xs text-slate-500 mb-1">Forbidden Keywords</label>
                    <textarea 
                      value={config.forbiddenKeywords}
                      onChange={(e) => setConfig({...config, forbiddenKeywords: e.target.value})}
                      className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm h-20 focus:outline-none"
                      placeholder="e.g. logo, text, human"
                    />
                  </div>
                </div>
              </section>
            </div>

            <div className="space-y-6">
              <section className="bg-slate-900 border border-slate-800 rounded-xl p-6 shadow-xl">
                <h2 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-6">Execution Timings</h2>
                <div className="space-y-6">
                  <div>
                    <div className="flex justify-between mb-2">
                      <label className="text-xs text-slate-500">Step Delay (Seconds)</label>
                      <span className="text-xs text-blue-400 font-mono">{config.stepDelay}s</span>
                    </div>
                    <input 
                      type="range" min="1" max="10" 
                      value={config.stepDelay}
                      onChange={(e) => setConfig({...config, stepDelay: parseInt(e.target.value)})}
                      className="w-full h-1 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-blue-600"
                    />
                  </div>
                  <div>
                    <div className="flex justify-between mb-2">
                      <label className="text-xs text-slate-500">Auto-Flow Delay (Seconds)</label>
                      <span className="text-xs text-blue-400 font-mono">{config.flowDelay}s</span>
                    </div>
                    <input 
                      type="range" min="1" max="10" 
                      value={config.flowDelay}
                      onChange={(e) => setConfig({...config, flowDelay: parseInt(e.target.value)})}
                      className="w-full h-1 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-blue-600"
                    />
                  </div>
                </div>
              </section>

              <section className="bg-slate-900 border border-slate-800 rounded-xl p-6 shadow-xl border-t-4 border-t-blue-600/50">
                <div className="flex items-center gap-2 mb-6">
                  <AlertTriangle size={18} className="text-amber-500" />
                  <h2 className="text-sm font-semibold text-slate-400 uppercase tracking-wider">Vecteezy Specifics</h2>
                </div>
                <div className="space-y-4">
                  <div>
                    <label className="block text-xs text-slate-500 mb-1">License Type</label>
                    <div className="grid grid-cols-2 gap-2">
                      {['free', 'pro'].map(l => (
                        <button
                          key={l}
                          onClick={() => setConfig({...config, vecteezyLicense: l})}
                          className={`py-1.5 text-xs rounded-md capitalize border ${config.vecteezyLicense === l ? 'bg-blue-600 border-blue-500' : 'bg-slate-800 border-slate-700 text-slate-400'}`}
                        >
                          {l}
                        </button>
                      ))}
                    </div>
                  </div>
                  <div>
                    <label className="block text-xs text-slate-500 mb-1">AI Software Reference</label>
                    <select 
                      value={config.vecteezyAiSoftware}
                      onChange={(e) => setConfig({...config, vecteezyAiSoftware: e.target.value})}
                      className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none"
                    >
                      <option value="Midjourney">Midjourney</option>
                      <option value="Stable Diffusion">Stable Diffusion</option>
                      <option value="DALL-E">DALL-E</option>
                      <option value="Other">Other (Manual)</option>
                    </select>
                  </div>
                </div>
              </section>

              <button 
                onClick={() => saveSettings(config)}
                className="w-full py-3 bg-emerald-600 hover:bg-emerald-500 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-emerald-900/20 transition transform active:scale-95"
              >
                <Save size={18} /> SAVE ALL CHANGES
              </button>
            </div>
          </div>
        )}
      </div>

      <footer className="max-w-6xl mx-auto mt-12 pt-8 border-t border-slate-900 flex justify-between items-center text-slate-600 text-[10px] uppercase tracking-widest">
        <div>FANZZ AI v1.0.4 (PRIVATE RELEASE)</div>
        <div className="flex gap-4">
          <span>NO CREDITS SYSTEM</span>
          <span>UNLIMITED PERSONAL USE</span>
        </div>
      </footer>
    </div>
  );
};

export default App;
